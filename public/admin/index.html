
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager | Bulbul Ahmed Foundation Trust</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 600px;
      margin: 50px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .btn {
      background-color: #800020;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }
    .btn:hover {
      background-color: #600018;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div id="nc-root"></div>
  
  <div class="container" id="loading-container">
    <h1>BAFT Content Manager</h1>
    <p>Loading content management system...</p>
    <div id="error-container" style="display: none;"></div>
  </div>

  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  <script>
    console.log("Admin CMS page loaded");
    
    let hasTimedOut = false;
    
    // Set timeout to prevent infinite loading
    const loadingTimeout = setTimeout(() => {
      hasTimedOut = true;
      console.log("CMS loading timeout");
      
      const errorContainer = document.getElementById('error-container');
      const loadingContainer = document.getElementById('loading-container');
      
      if (errorContainer && loadingContainer) {
        errorContainer.style.display = 'block';
        errorContainer.innerHTML = `
          <div class="error">
            <h3>CMS Loading Timeout</h3>
            <p>The CMS is taking too long to load. This usually means:</p>
            <ul style="text-align: left;">
              <li>Netlify Identity is not enabled</li>
              <li>Git Gateway is not configured</li>
              <li>config.yml file has errors</li>
              <li>You need to be invited as an admin</li>
            </ul>
            <button class="btn" onclick="location.reload()">Try Again</button>
            <button class="btn" onclick="window.location.href='/admin'">Back to Admin</button>
          </div>
        `;
      }
    }, 8000);

    // Check if Netlify Identity is available
    if (window.netlifyIdentity) {
      console.log("Netlify Identity available");
      
      window.netlifyIdentity.on("init", user => {
        console.log("Netlify Identity initialized", user ? "with user" : "without user");
        
        if (!user && !hasTimedOut) {
          clearTimeout(loadingTimeout);
          document.body.innerHTML = `
            <div class="container">
              <h1>BAFT Content Manager</h1>
              <p>Please log in to access the content management system.</p>
              <button class="btn" onclick="window.netlifyIdentity.open()">Log In</button>
              <button class="btn" onclick="window.location.href='/admin'">Back to Admin</button>
            </div>
          `;
        }
      });

      window.netlifyIdentity.on("login", () => {
        console.log("User logged in, reloading...");
        clearTimeout(loadingTimeout);
        document.location.href = "/admin/index.html";
      });

      window.netlifyIdentity.on("error", err => {
        console.error("Netlify Identity error:", err);
        clearTimeout(loadingTimeout);
        
        const errorContainer = document.getElementById('error-container');
        if (errorContainer) {
          errorContainer.style.display = 'block';
          errorContainer.innerHTML = `
            <div class="error">
              <h3>Authentication Error</h3>
              <p>${err.message || 'Authentication failed'}</p>
              <button class="btn" onclick="location.reload()">Try Again</button>
            </div>
          `;
        }
      });
    } else {
      console.error("Netlify Identity not available");
      clearTimeout(loadingTimeout);
      
      document.body.innerHTML = `
        <div class="container">
          <div class="error">
            <h3>Netlify Identity Not Available</h3>
            <p>The Netlify Identity widget failed to load.</p>
            <button class="btn" onclick="location.reload()">Reload Page</button>
          </div>
        </div>
      `;
    }

    // Hide loading container when CMS loads successfully
    setTimeout(() => {
      const cmsRoot = document.getElementById('nc-root');
      const loadingContainer = document.getElementById('loading-container');
      
      if (cmsRoot && cmsRoot.children.length > 0 && loadingContainer) {
        console.log("CMS loaded successfully");
        clearTimeout(loadingTimeout);
        loadingContainer.style.display = 'none';
      }
    }, 3000);
  </script>
</body>
</html>
